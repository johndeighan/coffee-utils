// Generated by CoffeeScript 2.6.1
// call_stack.coffee
var doDebugStack;

import {
  undef,
  croak,
  assert
} from '@jdeighan/coffee-utils';

import {
  log,
  LOG
} from '@jdeighan/coffee-utils/log';

doDebugStack = false;

// ---------------------------------------------------------------------------
export var debugStack = function(flag = true) {
  doDebugStack = flag;
};

// ---------------------------------------------------------------------------
export var CallStack = class CallStack {
  constructor() {
    this.reset();
  }

  // ........................................................................
  call(funcName, hInfo) {
    var prefix;
    if (doDebugStack) {
      prefix = '   '.repeat(this.lStack.length);
      LOG(`${prefix}[> CALL ${funcName}]`);
    }
    this.lStack.push({funcName, hInfo});
  }

  // ........................................................................
  returnFrom(fName) {
    var funcName, hInfo, prefix;
    if (this.lStack.length === 0) {
      LOG(`returnFrom('${fName}') but stack is empty`);
      return undef;
    }
    ({funcName, hInfo} = this.lStack.pop());
    while ((funcName !== fName) && (this.lStack.length > 0)) {
      LOG(`[MISSING RETURN FROM ${funcName} (return from ${fName})]`);
      ({funcName, hInfo} = this.lStack.pop());
    }
    if (doDebugStack) {
      prefix = '   '.repeat(this.lStack.length);
      LOG(`${prefix}[< BACK ${fName}]`);
    }
    if (funcName === fName) {
      return hInfo;
    } else {
      this.dump();
      LOG(`BAD returnFrom('${fName}')`);
      return undef;
    }
  }

  // ........................................................................
  reset() {
    if (doDebugStack) {
      LOG("RESET STACK");
    }
    return this.lStack = [];
  }

  // ........................................................................
  dump(label = 'CALL STACK') {
    var i, item, j, len, ref;
    console.log(`${label}:`);
    ref = this.lStack;
    for (i = j = 0, len = ref.length; j < len; i = ++j) {
      item = ref[i];
      LOG(`${i}: ${JSON.stringify(item)}`);
    }
  }

};
