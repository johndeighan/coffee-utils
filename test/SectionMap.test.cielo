# SectionMap.test.cielo

import {assert} from '@jdeighan/exceptions'
import {tester} from '@jdeighan/unit-tester'
import {undef} from '@jdeighan/coffee-utils'
import {elem} from '@jdeighan/coffee-utils/html'
import {
	blockToArray, arrayToBlock, firstLine, remainingLines,
	normalizeBlock, truncateBlock,
	joinBlocks, forEachLine, forEachBlock, forEachSetOfBlocks,
	} from '@jdeighan/coffee-utils/block'

import {SectionMap} from '@jdeighan/coffee-utils/sectionmap'

# ---------------------------------------------------------------------------

(() ->
	map = new SectionMap([
		'html'
		'script'
		])
	tester.truthy {{LINE}}, map.isEmpty()
	tester.falsy  {{LINE}}, map.nonEmpty()

	map.section('script').add "x = 42"
	map.section('html').add   "<p>para</p>"
	tester.falsy  {{LINE}}, map.isEmpty()
	tester.truthy {{LINE}}, map.nonEmpty()

	tester.equal {{LINE}}, map.getBlock(), """
		<p>para</p>
		x = 42
		"""

	)()

# ---------------------------------------------------------------------------

(() ->
	map = new SectionMap([
		'Script'
		'startup'
		'# |||| ='
		'code'
		])
	tester.falsy {{LINE}}, map.isEmpty()
	tester.truthy  {{LINE}}, map.nonEmpty()

	map.section('code').add      "x = 42"
	map.section('startup').add   "n = 3"
	tester.falsy  {{LINE}}, map.isEmpty()
	tester.truthy {{LINE}}, map.nonEmpty()

	tester.equal {{LINE}}, map.getBlock(), """
		n = 3
		# |||| =
		x = 42
		"""

	)()

# ---------------------------------------------------------------------------
# --- Test processing

(() ->
	map = new SectionMap([
		'html'
		'script'
		])
	map.section('script').add "x = 42"
	map.section('html').add   "<p>para</p>"

	toJS = (line) -> return "#{line};"

	tester.equal {{LINE}}, map.getBlock(undef, {script: toJS}), """
		<p>para</p>
		x = 42;
		"""

	)()

# ---------------------------------------------------------------------------

(() ->
	map = new SectionMap([
		'html'
		'script'
		])
	map.section('script').add "x = 42"
	map.section('html').add   "<p>para</p>"

	toJS = (line) -> return "#{line};"
	addSpaces = (line) -> return line.replace('<p>', '<p> ') \
	                                 .replace('</p>', ' </p>')

	hProc = {
		script: toJS
		html: addSpaces
		}
	tester.equal {{LINE}}, map.getBlock(undef, hProc), """
		<p> para </p>
		x = 42;
		"""

	)()

# ---------------------------------------------------------------------------

(() ->
	map = new SectionMap([
		'html'
		[
			'Script'
			'code'
			]
		])
	map.section('code').add  "x = 42"
	map.section('html').add  "<p>para</p>"

	toJS = (line) -> return "#{line};"
	addSpaces = (line) -> return line.replace('<p>', '<p> ') \
	                                 .replace('</p>', ' </p>')

	hProc = {
		code: toJS
		html: addSpaces
		Script: (block) -> return elem('script', undef, block, "\t")
		}
	tester.equal {{LINE}}, map.getBlock(undef, hProc), """
		<p> para </p>
		<script>
			x = 42;
		</script>
		"""

	)()
