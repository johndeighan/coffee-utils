# fs.test.cielo

import {dirname, resolve} from 'path'
import {fileURLToPath} from 'url'
import {
	existsSync, copyFileSync, readFileSync, writeFileSync,
	} from 'fs'

import {assert, croak} from '@jdeighan/exceptions'
import {LOG} from '@jdeighan/exceptions/log'
import {debug} from '@jdeighan/exceptions/debug'
import {utest} from '@jdeighan/unit-tester'
import {undef} from '@jdeighan/coffee-utils'
import {
	mydir, myfile, myfullpath, mkpath, isFile, isDir, isSimpleFileName,
	getSubDirs, pathTo, getFullPath, parseSource, fileStub, fileExt,
	withExt, withUnderScore, forEachLineInFile, slurp, barf
	} from '@jdeighan/coffee-utils/fs'


my_dir = mydir(import.meta.url)
assert existsSync(my_dir)
my_fname = 'fs.test.js'
my_path = mkpath(my_dir, my_fname)

# ---------------------------------------------------------------------------

(() ->
	hOpt = {removeLeadingUnderScore: true}

	utest.equal {{LINE}}, mydir(import.meta.url), "c:/Users/johnd/coffee-utils/test"
	utest.equal {{LINE}}, myfile(import.meta.url), "fs.test.js"
	utest.equal {{LINE}}, myfullpath(import.meta.url),  "c:/Users/johnd/coffee-utils/test/fs.test.js"

	utest.equal {{LINE}}, withExt('file.py', 'svelte'), 'file.svelte'
	utest.equal {{LINE}}, withExt('file.py', 'svelte', hOpt), 'file.svelte'
	utest.equal {{LINE}}, withExt('_file.py', 'svelte', hOpt), 'file.svelte'

	utest.equal {{LINE}}, withExt('/bin/file.py', 'svelte'), '/bin/file.svelte'
	utest.equal {{LINE}}, withExt('/bin/file.py', 'svelte', hOpt), '/bin/file.svelte'
	utest.equal {{LINE}}, withExt('/bin/_file.py', 'svelte', hOpt), '/bin/file.svelte'

	utest.equal {{LINE}}, withUnderScore('file.py', 'svelte'), '_file.py'
	utest.equal {{LINE}}, withUnderScore('_file.py', 'svelte'), '__file.py'

	utest.equal {{LINE}}, withUnderScore('/bin/file.py', 'svelte'), '/bin/_file.py'
	utest.equal {{LINE}}, withUnderScore('/bin/_file.py', 'svelte'), '/bin/__file.py'
	)()

# ---------------------------------------------------------------------------

(() ->
	fname = 'block.test.coffee'

	utest.truthy {{LINE}}, existsSync("#{my_dir}/#{fname}")
	utest.falsy  {{LINE}}, existsSync("#{my_dir}/nosuchfile.test.coffee")

	utest.equal  {{LINE}}, pathTo("#{fname}", my_dir), mkpath(my_dir, fname)
	utest.equal  {{LINE}}, pathTo('myfile.txt', my_dir), mkpath(my_dir, 'myfile.txt')
	utest.equal  {{LINE}}, pathTo('test.txt', my_dir), mkpath(my_dir, 'subdirectory', 'test.txt')
	utest.equal  {{LINE}}, pathTo('myfile2.txt', my_dir), mkpath(my_dir, 'subdirectory', 'subdir', 'myfile2.txt')

	hOpt = {relative: true}
	utest.equal  {{LINE}}, pathTo("#{fname}", my_dir, hOpt), "./#{fname}"
	utest.equal  {{LINE}}, pathTo('myfile.txt', my_dir, hOpt), "./myfile.txt"
	utest.equal  {{LINE}}, pathTo('test.txt', my_dir, hOpt), "./subdirectory/test.txt"
	utest.equal  {{LINE}}, pathTo('myfile2.txt', my_dir, hOpt), "./subdirectory/subdir/myfile2.txt"

	hOpt2 = {relative: true, direction: 'up'}
	utest.equal  {{LINE}}, pathTo('package.json', my_dir, hOpt2), "../package.json"
	utest.equal  {{LINE}}, pathTo('.bashrc', my_dir, hOpt2), "../../.bashrc"
	)()

# ---------------------------------------------------------------------------

# --- dirs are returned in alphabetical order
utest.equal {{LINE}}, getSubDirs(my_dir), ['data','markdown','subdirectory']

utest.equal {{LINE}}, pathTo('test.txt', my_dir), \
		"#{my_dir}/subdirectory/test.txt"

# ---------------------------------------------------------------------------

utest.equal {{LINE}}, mkpath('/usr/lib', 'johnd'), '/usr/lib/johnd'
utest.equal {{LINE}}, mkpath('', '/usr/lib', undef, 'johnd'), '/usr/lib/johnd'
utest.equal {{LINE}}, mkpath("c:", 'local/user'), 'c:/local/user'
utest.equal {{LINE}}, mkpath('/usr', 'lib', 'local', 'johnd'),
		'/usr/lib/local/johnd'

utest.equal {{LINE}}, mkpath('\\usr\\lib', 'johnd'), '/usr/lib/johnd'
utest.equal {{LINE}}, mkpath("c:", 'local\\user'), 'c:/local/user'
utest.equal {{LINE}}, mkpath('\\usr', 'lib', 'local', 'johnd'),
		'/usr/lib/local/johnd'

utest.equal {{LINE}}, mkpath('C:\\Users\\johnd', 'cielo'), 'c:/Users/johnd/cielo'

# ---------------------------------------------------------------------------
# test getFullPath()

# --- current working directory is the root dir, i.e. parent of this directory
wd = mkpath(process.cwd())

rootdir = mkpath(resolve(my_dir, '..'))
assert rootdir == wd, "#{rootdir} should equal #{wd}"

debug "Current Working Directory = '#{wd}'"
debug "my_dir = '#{my_dir}'"
debug "my_fname = '#{my_fname}'"
debug "my_path = '#{my_path}'"
debug "rootdir = '#{rootdir}'"

# --- given a full path, only change \ to /
utest.equal {{LINE}}, getFullPath(my_path), my_path

# --- given a utest file name, prepend the current working directory
utest.equal {{LINE}}, getFullPath(my_fname), mkpath(rootdir, my_fname)

# --- leading . should be resolved
utest.equal {{LINE}}, getFullPath("./#{my_fname}"), mkpath(rootdir, my_fname)

# --- leading .. should be resolved
utest.equal {{LINE}}, getFullPath("./test/../#{my_fname}"), mkpath(rootdir, my_fname)

hSourceInfo = parseSource(import.meta.url)

utest.equal {{LINE}}, hSourceInfo.dir, my_dir
utest.equal {{LINE}}, hSourceInfo.filename, my_fname
utest.equal {{LINE}}, hSourceInfo.fullpath, my_path
utest.equal {{LINE}}, hSourceInfo.stub, fileStub(my_fname)
utest.equal {{LINE}}, hSourceInfo.ext, fileExt(my_fname)

hSourceInfo2 = parseSource(my_path)    # should be the same

utest.equal {{LINE}}, hSourceInfo2.dir, my_dir
utest.equal {{LINE}}, hSourceInfo2.filename, my_fname
utest.equal {{LINE}}, hSourceInfo.fullpath, my_path
utest.equal {{LINE}}, hSourceInfo2.stub, fileStub(my_fname)
utest.equal {{LINE}}, hSourceInfo2.ext, fileExt(my_fname)

hSourceInfo3 = parseSource(my_dir)     # should know that it's a directory

utest.equal {{LINE}}, hSourceInfo3.dir, my_dir
utest.equal {{LINE}}, hSourceInfo3.filename, undef
utest.equal {{LINE}}, hSourceInfo3.fullpath, my_dir
utest.equal {{LINE}}, hSourceInfo3.stub, undef
utest.equal {{LINE}}, hSourceInfo3.ext, undef

utest.equal {{LINE}}, parseSource("test.js"), {
	filename: 'test.js'
	stub: 'test'
	ext: '.js'
	}

utest.equal {{LINE}}, parseSource(my_path), {
	dir: my_dir
	fullpath: my_path
	filename: my_fname
	stub: fileStub(my_fname)
	purpose: 'test'
	ext: '.js'
	}

utest.equal {{LINE}}, parseSource("c:\\Users\\johnd\\oz\\src\\test.js"), {
	dir: 'c:/Users/johnd/oz/src'
	fullpath: 'c:/Users/johnd/oz/src/test.js'
	filename: 'test.js'
	stub: 'test'
	ext: '.js'
	}

if process.platform == 'win32'
	utest.truthy {{LINE}}, isDir('c:/Users')
	utest.truthy {{LINE}}, isDir('c:/Program Files')
	utest.falsy  {{LINE}}, isFile('c:/Users')
	utest.falsy  {{LINE}}, isFile('c:/Program Files')

	utest.falsy  {{LINE}}, isDir('c:/Windows/notepad.exe')
	utest.falsy  {{LINE}}, isDir(
		'c:/Program Files/Windows Media Player/wmplayer.exe'
		)
	utest.truthy {{LINE}}, isFile('c:/Windows/notepad.exe')
	utest.truthy {{LINE}}, isFile(
		'c:/Program Files/Windows Media Player/wmplayer.exe'
		)

	utest.truthy {{LINE}}, isSimpleFileName('notepad.exe')
	utest.falsy  {{LINE}}, isSimpleFileName(
		'c:/Program Files/Windows Media Player/wmplayer.exe'
		)

utest.equal {{LINE}}, fileExt('file.txt'), '.txt'
utest.equal {{LINE}}, fileExt('file.'), ''
utest.equal {{LINE}}, fileExt('file.99'), '.99'
utest.equal {{LINE}}, fileExt('file._txt'), '._txt'

filepath = pathTo('readline.txt', my_dir)
utest.equal {{LINE}}, filepath, "c:/Users/johnd/coffee-utils/test/readline.txt"

(() ->
	lLines = []
	await forEachLineInFile filepath, (line, lineNum) ->
		lLines.push line
		return
	utest.equal {{LINE}}, lLines, [
		'abc'
		'def'
		'ghi'
		'jkl'
		'mno'
		]
	)()
(() ->
	lLines = []
	await forEachLineInFile filepath, (line, lineNum) ->
		lLines.push line
		return if lineNum==3 then 'EOF' else undef
	utest.equal {{LINE}}, lLines, [
		'abc'
		'def'
		'ghi'
		]
	)()
(() ->
	utest.equal {{LINE}}, slurp(filepath, 2), """
		abc
		def
		"""
	)()
(() ->
	utest.equal {{LINE}}, slurp(filepath, 3), """
		abc
		def
		ghi
		"""
	)()
(() ->
	utest.equal {{LINE}}, slurp(filepath, 1000), """
		abc
		def
		ghi
		jkl
		mno
		"""
	)()
