# fs.test.cielo

import {dirname, resolve} from 'path'
import {fileURLToPath} from 'url'
import {
	existsSync, copyFileSync, readFileSync, writeFileSync,
	} from 'fs'

import {UnitTester} from '@jdeighan/unit-tester'
import {say, undef, assert} from '@jdeighan/coffee-utils'
import {debug} from '@jdeighan/coffee-utils/debug'
import {LOG} from '@jdeighan/coffee-utils/log'
import {
	mydir, mkpath, isFile, isDir, isSimpleFileName,
	getSubDirs, pathTo, getFullPath, parseSource, fileExt,
	withExt, withUnderScore, forEachLineInFile, slurp, barf
	} from '@jdeighan/coffee-utils/fs'

simple = new UnitTester()

dir = mydir(`import.meta.url`)
assert existsSync(dir)

# ---------------------------------------------------------------------------

hOpt = {removeLeadingUnderScore: true}

simple.equal {{LINE}}, withExt('file.py', 'svelte'), 'file.svelte'
simple.equal {{LINE}}, withExt('file.py', 'svelte', hOpt), 'file.svelte'
simple.equal {{LINE}}, withExt('_file.py', 'svelte', hOpt), 'file.svelte'

simple.equal {{LINE}}, withExt('/bin/file.py', 'svelte'), '/bin/file.svelte'
simple.equal {{LINE}}, withExt('/bin/file.py', 'svelte', hOpt), '/bin/file.svelte'
simple.equal {{LINE}}, withExt('/bin/_file.py', 'svelte', hOpt), '/bin/file.svelte'

simple.equal {{LINE}}, withUnderScore('file.py', 'svelte'), '_file.py'
simple.equal {{LINE}}, withUnderScore('_file.py', 'svelte'), '__file.py'

simple.equal {{LINE}}, withUnderScore('/bin/file.py', 'svelte'), '/bin/_file.py'
simple.equal {{LINE}}, withUnderScore('/bin/_file.py', 'svelte'), '/bin/__file.py'

# ---------------------------------------------------------------------------

(() ->
	fname = 'debug.test.coffee'

	simple.truthy {{LINE}}, existsSync("#{dir}/#{fname}")
	simple.falsy  {{LINE}}, existsSync("#{dir}/nosuchfile.test.coffee")
	simple.equal  {{LINE}}, pathTo("#{fname}", dir), "#{dir}/#{fname}"
	)()

# ---------------------------------------------------------------------------

# --- dirs are returned in alphabetical order
simple.equal {{LINE}}, getSubDirs(dir), ['data','markdown','subdirectory']

simple.equal {{LINE}}, pathTo('test.txt', dir), \
		"#{dir}/subdirectory/test.txt"

# ---------------------------------------------------------------------------

simple.equal {{LINE}}, mkpath('/usr/lib', 'johnd'), '/usr/lib/johnd'
simple.equal {{LINE}}, mkpath('', '/usr/lib', undef, 'johnd'), '/usr/lib/johnd'
simple.equal {{LINE}}, mkpath("c:", 'local/user'), 'c:/local/user'
simple.equal {{LINE}}, mkpath('/usr', 'lib', 'local', 'johnd'),
		'/usr/lib/local/johnd'

simple.equal {{LINE}}, mkpath('\\usr\\lib', 'johnd'), '/usr/lib/johnd'
simple.equal {{LINE}}, mkpath("c:", 'local\\user'), 'c:/local/user'
simple.equal {{LINE}}, mkpath('\\usr', 'lib', 'local', 'johnd'),
		'/usr/lib/local/johnd'

simple.equal {{LINE}}, mkpath('C:\\Users\\johnd', 'cielo'), 'c:/Users/johnd/cielo'

# ---------------------------------------------------------------------------
# test getFullPath()

# --- current working directory is the root dir, i.e. parent of this directory
wd = mkpath(process.cwd())

myfname = 'fs.test.coffee'
mypath = mkpath(dir, myfname)
rootdir = mkpath(resolve(dir, '..'))
assert rootdir == wd, "#{rootdir} should equal #{wd}"

debug "Current Working Directory = '#{wd}'"
debug "dir = '#{dir}'"
debug "myfname = '#{myfname}'"
debug "mypath = '#{mypath}'"
debug "rootdir = '#{rootdir}'"

# --- given a full path, only change \ to /
simple.equal {{LINE}}, getFullPath(mypath), mypath

# --- given a simple file name, prepend the current working directory
simple.equal {{LINE}}, getFullPath(myfname), mkpath(rootdir, myfname)

# --- leading . should be resolved
simple.equal {{LINE}}, getFullPath("./#{myfname}"), mkpath(rootdir, myfname)

# --- leading .. should be resolved
simple.equal {{LINE}}, getFullPath("./test/../#{myfname}"), mkpath(rootdir, myfname)

simple.equal {{LINE}}, parseSource('unit test'), {
	filename: 'unit test'
	stub: 'unit test'
	}

simple.equal {{LINE}}, parseSource("test.js"), {
	filename: 'test.js'
	stub: 'test'
	ext: '.js'
	}

simple.equal {{LINE}}, parseSource("c:/Users/johnd/oz/src/test.js"), {
	dir: 'c:/Users/johnd/oz/src'
	fullpath: 'c:/Users/johnd/oz/src/test.js'
	filename: 'test.js'
	stub: 'test'
	ext: '.js'
	}

simple.equal {{LINE}}, parseSource("c:\\Users\\johnd\\oz\\src\\test.js"), {
	dir: 'c:/Users/johnd/oz/src'
	fullpath: 'c:/Users/johnd/oz/src/test.js'
	filename: 'test.js'
	stub: 'test'
	ext: '.js'
	}

if process.platform == 'win32'
	simple.truthy {{LINE}}, isDir('c:/Users')
	simple.truthy {{LINE}}, isDir('c:/Program Files')
	simple.falsy  {{LINE}}, isFile('c:/Users')
	simple.falsy  {{LINE}}, isFile('c:/Program Files')

	simple.falsy  {{LINE}}, isDir('c:/Windows/notepad.exe')
	simple.falsy  {{LINE}}, isDir(
		'c:/Program Files/Windows Media Player/wmplayer.exe'
		)
	simple.truthy {{LINE}}, isFile('c:/Windows/notepad.exe')
	simple.truthy {{LINE}}, isFile(
		'c:/Program Files/Windows Media Player/wmplayer.exe'
		)

	simple.truthy {{LINE}}, isSimpleFileName('notepad.exe')
	simple.falsy  {{LINE}}, isSimpleFileName(
		'c:/Program Files/Windows Media Player/wmplayer.exe'
		)

simple.equal {{LINE}}, fileExt('file.txt'), '.txt'
simple.equal {{LINE}}, fileExt('file.'), ''
simple.equal {{LINE}}, fileExt('file.99'), '.99'
simple.equal {{LINE}}, fileExt('file._txt'), '._txt'

filepath = pathTo('readline.txt', dir)
simple.equal {{LINE}}, filepath, "c:/Users/johnd/coffee-utils/test/readline.txt"

(() ->
	lLines = []
	await forEachLineInFile filepath, (line, lineNum) ->
		lLines.push line
		return
	simple.equal {{LINE}}, lLines, [
		'abc'
		'def'
		'ghi'
		'jkl'
		'mno'
		]
	)()
(() ->
	lLines = []
	await forEachLineInFile filepath, (line, lineNum) ->
		lLines.push line
		return if lineNum==3 then 'EOF' else undef
	simple.equal {{LINE}}, lLines, [
		'abc'
		'def'
		'ghi'
		]
	)()
(() ->
	simple.equal {{LINE}}, slurp(filepath, 2), """
		abc
		def
		"""
	)()
(() ->
	simple.equal {{LINE}}, slurp(filepath, 3), """
		abc
		def
		ghi
		"""
	)()
(() ->
	simple.equal {{LINE}}, slurp(filepath, 1000), """
		abc
		def
		ghi
		jkl
		mno
		"""
	)()
