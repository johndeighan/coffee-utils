# html.test.cielo

import {assert} from '@jdeighan/exceptions'
import {UnitTester, utest} from '@jdeighan/unit-tester'
import {undef} from '@jdeighan/coffee-utils'
import {
	blockToArray, arrayToBlock, firstLine, remainingLines,
	normalizeBlock, truncateBlock,
	joinBlocks, forEachLine, forEachBlock, forEachSetOfBlocks,
	} from '@jdeighan/coffee-utils/block'

import {parsetag, elem} from '@jdeighan/coffee-utils/html'

# ---------------------------------------------------------------------------

class HtmlTester extends UnitTester

	transformValue: (str) ->
		return parsetag(str)

htmlTester = new HtmlTester()

# ---------------------------------------------------------------------------

htmlTester.like {{LINE}}, 'p', {
	type: 'tag'
	tagName: 'p'
	orgtag: 'p'
	}

# --- attributes - <name>=<value>    no intervening spaces
htmlTester.like {{LINE}}, 'p type=bold', {
	type: 'tag'
	tagName: 'p'
	orgtag: 'p'
	hAttr: {
		type: {
			quote: ''
			value: 'bold'
			}
		}
	}

# --- attributes - alternate quoting
htmlTester.like {{LINE}}, 'p type="bold"', {
	type: 'tag'
	tagName: 'p'
	orgtag: 'p'
	hAttr: {
		type: {
			quote: '"'
			value: 'bold'
			}
		}
	}

# --- attributes - alternate quoting
htmlTester.like {{LINE}}, "p type='bold'", {
	type: 'tag'
	tagName: 'p'
	orgtag: 'p'
	hAttr: {
		type: {
			quote: "'"
			value: 'bold'
			}
		}
	}

# --- attributes - alternate quoting
htmlTester.like {{LINE}}, 'p type={bold}', {
	type: 'tag'
	tagName: 'p'
	orgtag: 'p'
	hAttr: {
		type: {
			quote: '{'
			value: 'bold'
			}
		}
	}

# --- Included text

htmlTester.like {{LINE}}, 'p type=bold a paragraph', {
	type: 'tag'
	tagName: 'p'
	orgtag: 'p'
	hAttr: {
		type: {
			quote: ''
			value: 'bold'
			}
		}
	text: 'a paragraph'
	}

htmlTester.like {{LINE}}, 'p type="bold" a paragraph', {
	type: 'tag'
	tagName: 'p'
	orgtag: 'p'
	hAttr: {
		type: {
			quote: '"'
			value: 'bold'
			}
		}
	text: 'a paragraph'
	}

htmlTester.like {{LINE}}, "p type='bold' a paragraph", {
	type: 'tag'
	tagName: 'p'
	orgtag: 'p'
	hAttr: {
		type: {
			quote: "'"
			value: 'bold'
			}
		}
	text: 'a paragraph'
	}

htmlTester.like {{LINE}}, 'p type={bold} a paragraph', {
	type: 'tag'
	tagName: 'p'
	orgtag: 'p'
	hAttr: {
		type: {
			quote: '{'
			value: 'bold'
			}
		}
	text: 'a paragraph'
	}

# --- classes
htmlTester.like {{LINE}}, 'p.blue', {
	type: 'tag'
	tagName: 'p'
	orgtag: 'p'
	hAttr: {
		class: {
			quote: '"'
			value: 'blue'
			}
		}
	}

# --- subtypes - they also become classes
htmlTester.like {{LINE}}, 'div:markdown', {
	type: 'tag'
	tagName: 'div'
	orgtag: 'div:markdown'
	subtype: 'markdown'
	hAttr: {
		class: {
			quote: '"'
			value: 'markdown'
			}
		}
	}

# --- bind to variable
htmlTester.like {{LINE}}, 'canvasVar = canvas', {
	type: 'tag'
	tagName: 'canvas'
	orgtag: 'canvas'
	hAttr: {
		'bind:this': {
			quote: '{'
			value: 'canvasVar'
			}
		}
	}

# --- bind to variable, plus attributes
htmlTester.like {{LINE}}, 'canvasVar = canvas width=800 height=600', {
	type: 'tag'
	tagName: 'canvas'
	orgtag: 'canvas'
	hAttr: {
		'bind:this': {
			quote: '{'
			value: 'canvasVar'
			}
		width: {
			quote: ''
			value: '800'
			}
		height: {
			quote: ''
			value: '600'
			}
		}
	}

# --- bind to variable, text that looks like attributes
htmlTester.like {{LINE}}, 'canvasVar = canvas "width=800 height=600"', {
	type: 'tag'
	tagName: 'canvas'
	orgtag: 'canvas'
	hAttr: {
		'bind:this': {
			quote: '{'
			value: 'canvasVar'
			}
		}
	text: "width=800 height=600"
	}

# --- tag script:startup automatically gets attr context="module"
htmlTester.like {{LINE}}, 'script:startup', {
	type: 'tag'
	tagName: 'script'
	orgtag: 'script:startup'
	hAttr: {
		class: {
			quote: '"'
			value: 'startup'
			}
		context: {
			quote: '"'
			value: 'module'
			}
		}
	}

# --- special handling of svelte:<something> tags
htmlTester.like {{LINE}}, 'svelte:head', {
	type: 'tag'
	subtype: 'head'
	tagName: 'svelte:head'
	orgtag: 'svelte:head'
	}

# --- Test elem()
html = elem('script', undef, 'x = 42', "\t")
utest.equal {{LINE}}, html, """
	<script>
		x = 42
	</script>
	"""
